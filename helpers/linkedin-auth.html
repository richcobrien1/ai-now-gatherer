<!DOCTYPE html>
<html>
<head>
  <title>LinkedIn Auth Helper</title>
  <style>
    body { font-family: Arial; max-width: 600px; margin: 50px auto; padding: 20px; }
    button { background: #0077b5; color: white; padding: 15px 30px; border: none; cursor: pointer; font-size: 16px; }
    button:hover { background: #005582; }
    pre { background: #f4f4f4; padding: 15px; overflow-x: auto; }
    .step { margin: 30px 0; padding: 20px; border: 2px solid #ddd; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>LinkedIn OAuth Helper</h1>
  
  <div class="step">
    <h2>Step 1: Authorize</h2>
    <p>Click this button to authorize with LinkedIn:</p>
    <button onclick="authorize()">üîê Authorize LinkedIn</button>
  </div>
  
  <div class="step">
    <h2>Step 2: Get Access Token</h2>
    <p>After authorizing, you'll be redirected back with a code in the URL.</p>
    <p>Paste the code here:</p>
    <input type="text" id="authCode" placeholder="Paste authorization code" style="width: 100%; padding: 10px;">
    <br><br>
    <button onclick="getToken()">Get Access Token</button>
  </div>
  
  <div class="step" id="result" style="display: none;">
    <h2>Step 3: Your Credentials</h2>
    <pre id="output"></pre>
    <button onclick="copyToClipboard()">üìã Copy to Clipboard</button>
  </div>

  <script>
    async function getConfig() {
      try {
        const r = await fetch('/api/linkedin/config');
        return await r.json();
      } catch (e) {
        return { client_id: '', redirect_uri: location.origin + '/linkedin-callback' };
      }
    }

    async function authorize() {
      const cfg = await getConfig();
      const scope = 'openid profile email w_member_social';
      const state = Math.random().toString(36).substring(7);
      const authUrl = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${cfg.client_id}&redirect_uri=${encodeURIComponent(cfg.redirect_uri)}&state=${state}&scope=${encodeURIComponent(scope)}`;
      window.open(authUrl, '_blank');
      alert('After authorizing, copy the "code" parameter from the URL and paste it in Step 2');
    }

    async function getToken() {
      const code = document.getElementById('authCode').value.trim();
      if (!code) { alert('Please paste the authorization code'); return; }
      try {
        const r = await fetch('/api/linkedin/exchange', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code }) });
        const data = await r.json();
        if (r.ok) {
          const output = `Access Token: ${data.access_token || ''}\n\nLinkedIn URN: ${data.urn ? 'urn:li:person:' + data.urn : ''}\n\nRun these commands:\nwrangler secret put LINKEDIN_ACCESS_TOKEN --config wrangler-social.toml\nwrangler secret put LINKEDIN_AUTHOR_URN --config wrangler-social.toml`;
          document.getElementById('output').textContent = output;
          document.getElementById('result').style.display = 'block';
        } else {
          alert('Error: ' + JSON.stringify(data));
        }
      } catch (e) { alert('Error: ' + e.message); }
    }

    function copyToClipboard() { const text = document.getElementById('output').textContent; navigator.clipboard.writeText(text); alert('Copied to clipboard!'); }
  </script>
</body>
</html>